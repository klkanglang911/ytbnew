groups:
  - name: youtube_proxy_alerts
    interval: 30s
    rules:
      # åº”ç”¨ä¸å¯ç”¨å‘Šè­¦
      - alert: YouTubeProxyDown
        expr: up{job="youtube_proxy"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "ğŸš¨ YouTube Proxy æœåŠ¡ä¸å¯ç”¨"
          description: "åº”ç”¨å·²ç¦»çº¿è¶…è¿‡ 2 åˆ†é’Ÿï¼Œè¯·ç«‹å³æ£€æŸ¥"

      # é«˜é”™è¯¯ç‡å‘Šè­¦
      - alert: HighErrorRate
        expr: |
          (
            rate(ytdlp_request_errors_total[5m])
            /
            (rate(ytdlp_requests_total[5m]) + 1)
          ) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "âš ï¸ æµè§£æé”™è¯¯ç‡è¿‡é«˜"
          description: "è¿‡å» 5 åˆ†é’Ÿå†…é”™è¯¯ç‡è¶…è¿‡ 10%ï¼Œè¯·æ£€æŸ¥ YouTube API æ˜¯å¦æœ‰å˜åŒ–"

      # Redis è¿æ¥å¤±è´¥
      - alert: RedisConnectionFailed
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "ğŸ”´ Redis è¿æ¥å¤±è´¥"
          description: "æ— æ³•è¿æ¥åˆ° Redis ç¼“å­˜æœåŠ¡ï¼Œè¯·æ£€æŸ¥å®¹å™¨çŠ¶æ€"

      # å¹¶å‘æµè¿‡å¤š
      - alert: HighConcurrentStreams
        expr: active_streams > 8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ğŸ“ˆ å¹¶å‘æµæ¥è¿‘é™åˆ¶"
          description: "å½“å‰å¹¶å‘æµæ•°: {{ $value }} / 10ï¼Œæ¥è¿‘å®¹é‡é™åˆ¶"

      # ç¼“å­˜å‘½ä¸­ç‡ä½
      - alert: LowCacheHitRate
        expr: cache_hit_rate < 0.3
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "ğŸ’¾ ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½"
          description: "è¿‡å» 10 åˆ†é’Ÿç¼“å­˜å‘½ä¸­ç‡: {{ $value }}%ï¼Œå¯èƒ½éœ€è¦ä¼˜åŒ–ç¼“å­˜ç­–ç•¥"

      # å“åº”æ—¶é—´è¿‡é•¿
      - alert: SlowResponseTime
        expr: histogram_quantile(0.95, ytdlp_request_duration_seconds) > 30
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "â±ï¸ å“åº”æ—¶é—´è¿‡é•¿"
          description: "95 åˆ†ä½æ•°å“åº”æ—¶é—´: {{ $value }}sï¼Œå¯èƒ½éœ€è¦å¢åŠ èµ„æºæˆ–ä¼˜åŒ–é…ç½®"

      # Prometheus æ•°æ®åº“å ç”¨è¿‡å¤š
      - alert: PrometheusHighDiskUsage
        expr: node_filesystem_avail_bytes{mountpoint="/prometheus"} / node_filesystem_size_bytes{mountpoint="/prometheus"} < 0.2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "ğŸ’¿ Prometheus ç£ç›˜ç©ºé—´å³å°†ç”¨å°½"
          description: "å‰©ä½™ç©ºé—´ä¸è¶³ 20%ï¼Œè¯·è€ƒè™‘æ¸…ç†æˆ–å¢åŠ å­˜å‚¨"

      # å®¹å™¨é‡å¯é¢‘ç¹
      - alert: ContainerRestartingFrequently
        expr: rate(container_last_seen{name="ytb_app"}[5m]) > 0.01
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ğŸ”„ åº”ç”¨å®¹å™¨é¢‘ç¹é‡å¯"
          description: "æ£€æµ‹åˆ°åº”ç”¨å®¹å™¨åœ¨é¢‘ç¹é‡å¯ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
